name: Build SmartCache Enterprise - All Platforms + Android APK

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  pull_request:
    branches: [ main ]
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-executables:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [20.x]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3 python3-dev sqlite3 libsqlite3-dev
        
    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install sqlite3 python@3.11
        
    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install python sqlite
        
    - name: Install dependencies
      run: npm install
      
    - name: Build executables
      run: |
        npm run build
        
    - name: Upload Linux artifacts
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: smartcache-linux
        path: dist/smartcache-linux*
        
    - name: Upload Windows artifacts  
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: smartcache-windows
        path: dist/smartcache-windows.exe
        
    - name: Upload macOS artifacts
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: smartcache-macos
        path: dist/smartcache-macos*

  build-android-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install Android tools
      run: |
        echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
        echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;25.2.9519653"
        
    - name: Install system dependencies for native compilation
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3 python3-dev sqlite3 libsqlite3-dev
        
    - name: Create Android project structure
      run: |
        mkdir -p android/app/src/main/assets/nodejs-project
        mkdir -p android/app/src/main/java/com/smartcache
        mkdir -p android/app/src/main/res/values
        
    - name: Install dependencies with native compilation
      run: |
        npm install
        npm rebuild
        
    - name: Download Node.js for Android and copy project
      run: |
        # Download Node.js binary for Android ARM64
        mkdir -p android/app/src/main/assets/nodejs-project/bin
        wget https://nodejs.org/dist/v20.18.0/node-v20.18.0-linux-arm64.tar.gz
        tar -xzf node-v20.18.0-linux-arm64.tar.gz
        cp node-v20.18.0-linux-arm64/bin/node android/app/src/main/assets/nodejs-project/bin/
        chmod +x android/app/src/main/assets/nodejs-project/bin/node
        
        # Copy Node.js project files
        cp -r src android/app/src/main/assets/nodejs-project/
        cp -r node_modules android/app/src/main/assets/nodejs-project/
        cp package.json android/app/src/main/assets/nodejs-project/
        cp .env.example android/app/src/main/assets/nodejs-project/
        
        # Create startup script
        cat > android/app/src/main/assets/nodejs-project/start.sh << 'EOF'
        #!/system/bin/sh
        export NODE_PATH="./node_modules"
        export HOME="."
        ./bin/node src/smartcache.js
        EOF
        chmod +x android/app/src/main/assets/nodejs-project/start.sh
        
    - name: Generate Android manifest
      run: |
        cat > android/app/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="com.smartcache.enterprise">
            
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
            <uses-permission android:name="android.permission.WAKE_LOCK" />
            <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
            <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />
            
            <application
                android:allowBackup="true"
                android:icon="@mipmap/ic_launcher"
                android:label="SmartCache Enterprise"
                android:theme="@style/AppTheme"
                android:usesCleartextTraffic="true">
                
                <activity
                    android:name=".MainActivity"
                    android:exported="true">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
                
                <service
                    android:name=".SmartCacheService"
                    android:enabled="true"
                    android:exported="false"
                    android:foregroundServiceType="dataSync" />
                    
            </application>
        </manifest>
        EOF
        
    - name: Create Android MainActivity
      run: |
        cat > android/app/src/main/java/com/smartcache/MainActivity.java << 'EOF'
        package com.smartcache.enterprise;
        
        import android.app.Activity;
        import android.content.Intent;
        import android.net.Uri;
        import android.os.Bundle;
        import android.webkit.WebView;
        import android.webkit.WebViewClient;
        import android.widget.Toast;
        
        public class MainActivity extends Activity {
            private WebView webView;
            
            @Override
            protected void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                
                // Start SmartCache service
                Intent serviceIntent = new Intent(this, SmartCacheService.class);
                startForegroundService(serviceIntent);
                
                // Setup WebView for dashboard
                webView = new WebView(this);
                webView.getSettings().setJavaScriptEnabled(true);
                webView.getSettings().setDomStorageEnabled(true);
                webView.setWebViewClient(new WebViewClient());
                
                setContentView(webView);
                
                // Load SmartCache dashboard
                webView.loadUrl("http://localhost:3000");
                
                Toast.makeText(this, "SmartCache Enterprise Started", Toast.LENGTH_LONG).show();
            }
        }
        EOF
        
    - name: Create SmartCache Android Service
      run: |
        cat > android/app/src/main/java/com/smartcache/SmartCacheService.java << 'EOF'
        package com.smartcache.enterprise;
        
        import android.app.Notification;
        import android.app.NotificationChannel;
        import android.app.NotificationManager;
        import android.app.Service;
        import android.content.Intent;
        import android.content.res.AssetManager;
        import android.os.Build;
        import android.os.IBinder;
        import android.util.Log;
        import java.io.*;
        import java.util.concurrent.ExecutorService;
        import java.util.concurrent.Executors;
        
        public class SmartCacheService extends Service {
            private static final String TAG = "SmartCacheService";
            private static final String CHANNEL_ID = "SmartCacheChannel";
            private static final int NOTIFICATION_ID = 1;
            private ExecutorService executor;
            private Process nodeProcess;
            
            @Override
            public void onCreate() {
                super.onCreate();
                createNotificationChannel();
                executor = Executors.newSingleThreadExecutor();
            }
            
            @Override
            public int onStartCommand(Intent intent, int flags, int startId) {
                startForeground(NOTIFICATION_ID, createNotification());
                
                executor.execute(() -> {
                    try {
                        // Extract Node.js project from assets
                        extractNodeProject();
                        
                        // Start Node.js SmartCache
                        startNodeProcess();
                        
                    } catch (Exception e) {
                        Log.e(TAG, "Failed to start SmartCache", e);
                    }
                });
                
                return START_STICKY;
            }
            
            private void extractNodeProject() throws IOException {
                File projectDir = new File(getFilesDir(), "nodejs-project");
                if (projectDir.exists()) {
                    Log.i(TAG, "Node.js project already extracted");
                    return;
                }
                
                Log.i(TAG, "Extracting Node.js project from assets...");
                copyAssets("nodejs-project", projectDir);
                
                // Set executable permissions for Node.js binary
                File nodeExecutable = new File(projectDir, "bin/node");
                if (nodeExecutable.exists()) {
                    nodeExecutable.setExecutable(true, false);
                    Log.i(TAG, "Node.js executable permissions set");
                }
                
                // Set executable permissions for start script
                File startScript = new File(projectDir, "start.sh");
                if (startScript.exists()) {
                    startScript.setExecutable(true, false);
                    Log.i(TAG, "Start script permissions set");
                }
            }
            
            private void copyAssets(String assetPath, File targetDir) throws IOException {
                AssetManager assetManager = getAssets();
                String[] files = assetManager.list(assetPath);
                
                if (!targetDir.exists()) {
                    targetDir.mkdirs();
                }
                
                if (files != null && files.length > 0) {
                    // It's a directory
                    for (String file : files) {
                        copyAssets(assetPath + "/" + file, new File(targetDir, file));
                    }
                } else {
                    // It's a file
                    try (InputStream in = assetManager.open(assetPath);
                         FileOutputStream out = new FileOutputStream(targetDir)) {
                        byte[] buffer = new byte[1024];
                        int read;
                        while ((read = in.read(buffer)) != -1) {
                            out.write(buffer, 0, read);
                        }
                    }
                }
            }
            
            private void startNodeProcess() throws IOException {
                File projectDir = new File(getFilesDir(), "nodejs-project");
                File nodeExecutable = new File(projectDir, "bin/node");
                File smartcacheScript = new File(projectDir, "src/smartcache.js");
                
                if (!nodeExecutable.exists()) {
                    Log.e(TAG, "Node.js executable not found: " + nodeExecutable.getAbsolutePath());
                    return;
                }
                
                if (!smartcacheScript.exists()) {
                    Log.e(TAG, "SmartCache script not found: " + smartcacheScript.getAbsolutePath());
                    return;
                }
                
                Log.i(TAG, "Starting Node.js process...");
                
                ProcessBuilder pb = new ProcessBuilder(
                    nodeExecutable.getAbsolutePath(),
                    smartcacheScript.getAbsolutePath()
                );
                pb.directory(projectDir);
                pb.environment().put("NODE_PATH", new File(projectDir, "node_modules").getAbsolutePath());
                pb.environment().put("HOME", projectDir.getAbsolutePath());
                
                nodeProcess = pb.start();
                
                // Log Node.js output for debugging
                new Thread(() -> {
                    try (BufferedReader reader = new BufferedReader(new InputStreamReader(nodeProcess.getInputStream()))) {
                        String line;
                        while ((line = reader.readLine()) != null) {
                            Log.i(TAG, "Node.js: " + line);
                        }
                    } catch (IOException e) {
                        Log.e(TAG, "Error reading Node.js output", e);
                    }
                }).start();
                
                Log.i(TAG, "SmartCache Node.js process started");
            }
            
            private Notification createNotification() {
                return new Notification.Builder(this, CHANNEL_ID)
                    .setContentTitle("SmartCache Enterprise")
                    .setContentText("AI Response Caching Active")
                    .setSmallIcon(R.mipmap.ic_launcher)
                    .build();
            }
            
            private void createNotificationChannel() {
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    NotificationChannel channel = new NotificationChannel(
                        CHANNEL_ID,
                        "SmartCache Service",
                        NotificationManager.IMPORTANCE_LOW
                    );
                    NotificationManager manager = getSystemService(NotificationManager.class);
                    manager.createNotificationChannel(channel);
                }
            }
            
            @Override
            public IBinder onBind(Intent intent) {
                return null;
            }
            
            @Override
            public void onDestroy() {
                super.onDestroy();
                if (nodeProcess != null) {
                    nodeProcess.destroy();
                }
                if (executor != null) {
                    executor.shutdown();
                }
            }
        }
        EOF
        
    - name: Create build.gradle and settings.gradle
      run: |
        # Create settings.gradle first
        cat > android/settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                gradlePluginPortal()
                google()
                mavenCentral()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        
        rootProject.name = "SmartCache"
        include ':app'
        EOF
        
        # Create root build.gradle
        cat > android/build.gradle << 'EOF'
        buildscript {
            repositories {
                gradlePluginPortal()
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.1.4'
            }
        }
        
        plugins {
            id 'com.android.application' version '8.1.4' apply false
        }
        
        allprojects {
            repositories {
                google()
                mavenCentral()
            }
        }
        EOF
        
        cat > android/app/build.gradle << 'EOF'
        plugins {
            id 'com.android.application'
        }
        
        android {
            namespace 'com.smartcache.enterprise'
            compileSdk 34
            
            defaultConfig {
                applicationId "com.smartcache.enterprise"
                minSdk 24
                targetSdk 34
                versionCode 1
                versionName "1.0"
                testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
            }
            
            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                    signingConfig signingConfigs.debug
                }
                debug {
                    applicationIdSuffix ".debug"
                    debuggable true
                }
            }
            
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_11
                targetCompatibility JavaVersion.VERSION_11
            }
            
            packagingOptions {
                pickFirst '**/libc++_shared.so'
                pickFirst '**/libjsc.so'
            }
        }
        
        dependencies {
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'androidx.core:core:1.12.0'
            implementation 'androidx.webkit:webkit:1.8.0'
        }
        EOF
        
    - name: Create gradle.properties and resources
      run: |
        # Create gradle.properties
        cat > android/gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
        org.gradle.parallel=true
        org.gradle.caching=true
        org.gradle.configureondemand=true
        android.useAndroidX=true
        android.enableJetifier=true
        android.defaults.buildfeatures.buildconfig=true
        android.nonTransitiveRClass=false
        android.nonFinalResIds=false
        EOF
        
        # Create app resources
        mkdir -p android/app/src/main/res/values
        mkdir -p android/app/src/main/res/mipmap-hdpi
        mkdir -p android/app/src/main/res/mipmap-mdpi
        mkdir -p android/app/src/main/res/mipmap-xhdpi
        mkdir -p android/app/src/main/res/mipmap-xxhdpi
        mkdir -p android/app/src/main/res/mipmap-xxxhdpi
        
        # Create strings.xml
        cat > android/app/src/main/res/values/strings.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <string name="app_name">SmartCache Enterprise</string>
        </resources>
        EOF
        
        # Create styles.xml
        cat > android/app/src/main/res/values/styles.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <style name="AppTheme" parent="Theme.AppCompat.Light.NoActionBar">
                <item name="colorPrimary">#4CAF50</item>
                <item name="colorPrimaryDark">#388E3C</item>
                <item name="colorAccent">#FF5722</item>
            </style>
        </resources>
        EOF
        
        # Create app icons using ImageMagick
        sudo apt-get install -y imagemagick
        
        # Create base icon
        convert -size 512x512 xc:"#4CAF50" -fill white -gravity center \
                -font Liberation-Sans-Bold -pointsize 72 -annotate +0+0 "SC" \
                android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
        
        # Generate different sizes
        convert android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png -resize 192x192 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
        convert android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png -resize 144x144 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
        convert android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png -resize 96x96 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
        convert android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png
        
    - name: Create gradle wrapper
      run: |
        cd android
        # Use Gradle wrapper from GitHub Actions
        gradle wrapper --gradle-version 8.5 --distribution-type all
        
    - name: Build Android APK
      run: |
        cd android
        ./gradlew assembleRelease
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: smartcache-android-apk
        path: android/app/build/outputs/apk/release/*.apk

  create-release:
    needs: [build-executables, build-android-apk]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create release assets
      run: |
        mkdir release-assets
        
        # Copy executables
        cp smartcache-linux/* release-assets/ || true
        cp smartcache-windows/* release-assets/ || true  
        cp smartcache-macos/* release-assets/ || true
        cp smartcache-android-apk/* release-assets/ || true
        
        # Create release info
        echo "SmartCache Enterprise - Universal AI Caching System" > release-assets/README.txt
        echo "Built on $(date)" >> release-assets/README.txt
        echo "Commit: $GITHUB_SHA" >> release-assets/README.txt
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'release'
      with:
        files: release-assets/*
        body: |
          ## SmartCache Enterprise - Complete Build
          
          ### 🚀 What's New
          - Universal AI API interception (OpenAI, Anthropic, Google, etc.)
          - Federated caching system with Supabase sync
          - Enterprise deployment tools
          - Real-time dashboard and analytics
          
          ### 📦 Downloads
          - **Windows**: `smartcache-windows.exe`
          - **Linux**: `smartcache-linux`
          - **macOS**: `smartcache-macos`  
          - **Android APK**: `smartcache-enterprise.apk`
          
          ### 🔧 Installation
          1. Download the appropriate version for your platform
          2. Copy `.env.example` to `.env` and configure Supabase credentials
          3. Run the executable or install APK
          4. Access dashboard at http://localhost:3000
          
          Built automatically with GitHub Actions ✨
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload to latest release (main branch)
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "latest"
        name: "Latest Development Build"
        files: release-assets/*
        prerelease: true
        body: |
          ## Latest Development Build
          
          This is an automated build from the main branch.
          Contains the latest features and improvements.
          
          **⚠️ Development Build**: May contain unstable features.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}